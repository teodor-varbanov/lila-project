---
- hosts: localhost
  gather_facts: no
  become: no

  vars:
    lila_name: "lila"
    mongo_name: "mongo"
    redis_name: "redis"
    tag: "dev1"
    front_port: "9663"
    listener_port: "9664"
    mongo_port: "27017"
    redis_port: "6379"

  tasks:
        
    - name: Get latest application code from GitHub
      git:
        repo: https://github.com/teodor-varbanov/lila-project.git
        version: feature
        dest: ./
        force: true
      environment:
        GIT_TERMINAL_PROMPT: 0

    - name: Add repo to DNF
      ansible.builtin.shell:
        dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo

    - name: Install Docker 
      ansible.builtin.shell:
        dnf install -y docker-ce docker-ce-cli containerd.io
      
    - name: Start Docker 
      ansible.builtin.shell:
        systemctl start docker

    - name: Enable Docker 
      ansible.builtin.shell:
        systemctl enable docker 
    

    - name: Build MongoDB image
      community.docker.docker_image:
        name: "{{ mongo_name }}:{{ tag }}"
        source: build
        build:
          path: ./mongo/
        state: present

    - name: Build Redis image
      community.docker.docker_image:
        name: "{{ redis_name }}:{{ tag }}"
        source: build
        build:
          path: ./redis/
        state: present

    - name: Run Redis container
      community.docker.docker_container:
        name: "{{ redis_name }}"
        image: "{{ redis_name }}:{{ tag }}"
        state: started
        detach: true
        ports:
          - "{{ redis_port }}:{{ redis_port }}"

    - name: Run MongoDB container
      community.docker.docker_container:
        name: "{{ mongo_name }}"
        image: "{{ mongo_name }}:{{ tag }}"
        state: started
        detach: true
        ports:
          - "{{ mongo_port }}:{{ mongo_port }}"
          
    - name: Build Lila Front (w/ litener) image
      community.docker.docker_image:
        name: "{{ lila_name }}:{{ tag }}"
        source: build
        build:
          path: ./lila/
        state: present
      
    - name: Run Lila (front and listener) container
      community.docker.docker_container:
        name: "{{ lila_name }}"
        image: "{{ lila_name }}:{{ tag }}"
        state: started
        detach: true
        ports:
          - "{{ front_port }}:{{ front_port }}"
